<!-- public/login-register.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Login/Register</title>
    <link href="/global.css" rel="stylesheet" type="text/css">
    <link href="/login-register.css" rel="stylesheet" type="text/css">
</head>

<body>
    <!-- <h1>Login Page</h1> -->
    <div id="centered-window">
        <form id="login-register-form">
            <div>
                <div id="error-message"></div>
                <br>
            </div>
            <div>
                <label class="input-label">Username:</label>
                <input autocomplete="username" id="username-input" required type="text">
            </div>
            <br>
            <div id="first-password">
                <label class="input-label">Password:</label>
                <input autocomplete="new-password" id="first-password-input" required type="password">
            </div>
            <br>
            <div id="second-password">
                <label class="input-label">Password again:</label>
                <input autocomplete="new-password" id="second-password-input" type="password">
            </div>
            <br>
            <div id="invitation-code">
                <label class="input-label">Invitation code:</label>
                <input class="text-input" id="invitation-code-input" type="text">
            </div>
            <br>
            <button class="button" id="submit-button" type="submit"></button>
        </form>
        <br>
        <button class="button" id="login-or-register"></button>

    </div>
    <script>
        let loginOrRegister = 'login'

        const errorMessage = document.getElementById('error-message')
        const button = document.getElementById('login-or-register')
        const secondPassword = document.getElementById('second-password')
        const invitationCode = document.getElementById('invitation-code')
        const submitButton = document.getElementById('submit-button')

        // set prewritten strings
        const loginText = 'Login'
        const registerText = 'Register'
        const accountText = 'To login'
        const noAccountText = 'To register'

        // sets names in script initially
        button.textContent = noAccountText
        submitButton.textContent = loginText

        button.addEventListener('click', () => {
            if (loginOrRegister === 'login') {
                secondPassword.style.visibility = 'visible'
                invitationCode.style.visibility = 'visible'
                button.textContent = accountText
                submitButton.textContent = registerText
                loginOrRegister = 'register'
            } else {
                secondPassword.style.visibility = 'hidden'
                invitationCode.style.visibility = 'hidden'
                button.textContent = noAccountText
                submitButton.textContent = loginText
                loginOrRegister = 'login'
            }

        })

        async function submit() {
            const username = document.getElementById('username-input').value
            const password = document.getElementById('first-password-input').value

            // convert password to sha512 in base64 format
            const passwordBuffer = new TextEncoder().encode(password)
            const hashedPassword = await crypto.subtle.digest('SHA-512', passwordBuffer);
            const base64Password = btoa(String.fromCharCode.apply(null, new Uint8Array(hashedPassword)));

            let dataToSend
            let url
            if (loginOrRegister === 'login') {
                dataToSend = {
                    Username: username,
                    Password: base64Password,
                }
                url = window.location.origin + '/login'
            } else {
                dataToSend = {
                    Username: username,
                    Password: base64Password,
                }
                url = window.location.origin + '/register'
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            const result = await response.json()

            errorMessage.textContent = result.Message
            if (result.Success) {
                errorMessage.style.color = '#adff2f'
                window.location.href = "/chat.html";
            } else {
                errorMessage.textContent = result.Message
            }
        }

        document.getElementById('login-register-form').addEventListener('submit', function (event) {
            event.preventDefault()
            submit().then(r => { })
        })
    </script>
</body>
</html>